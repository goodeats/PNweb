<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,500,700,900">
<style>
.box-item {
  border: 1px solid black;
  margin: 20px;
  list-style: none;
  font: 1rem/1.175 "BlinkMacSystemFont", -apple-system, "Roboto", sans-serif;
}

.card-item {
  width: 50px;
  height: 80px;
  display: inline-block;
  position: relative;
  margin: 20px;
  margin-right: -30px;
  background: white;
  border: 1px solid black;
  border-radius: 10px;
  text-align: center;
  font: 1rem/1.175 "BlinkMacSystemFont", -apple-system, "Roboto", sans-serif;
}

.card-name--top,
.card-name--bottom {
  position: absolute;
  padding: 5px;
}

.card-name--top {
  top: 0;
  left: 0;
}

.card-name--bottom {
  bottom: 0;
  right: 0;
  transform: rotate(180deg);
}

.card-suit {
  line-height: 80px;
}


</style>


<script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
<script>

Vue.component('card', {
  props: ['card'],
  template: `
    <li class="card-item">
      <span class="card-name--top">{{ pretty_card(card) }}</span>
      <span class="card-suit">{{ card.suit }}</span>
      <span class="card-name--bottom">{{ pretty_card(card) }} </span>
    </li>
  `,
  methods: {
    pretty_card: function(card){
      return card.name.toString().toUpperCase();
    }
  }
});

Vue.component('box', {
  props: ['player', 'cards'],
  template: `
    <li class="box-item">
      <h3 class="box-name--top">{{ pretty_card(player) }}</h3>
      <p class="box-score" v-html="player_score(player.score)"></p>
      <p>game_status: {{ player.game_status }}</p>
      <p>game_started: {{ player.game_started }}</p>
      <p>game_over: {{ player.game_over }}</p>
      <card
        v-for="hand in player.hands"
        :card="hand"
      ></card>
      <button v-if="player_can_hit(player)" @click="deal">Hit me!</button>
    </li>
  `,
  methods: {
    pretty_card: function(player){
      return player.name.toString().toUpperCase();
    },
    player_can_hit: function(player){
      return player.game_started && !player.game_ended;
    },
    player_score: function(score){
      var player_score = score[0];
      if (player_score > 21){
        this.player.game_status = 'You Lost :(';
        this.player.game_over = true;
      } else if (player_score === 21){
        this.player.game_status = 'You Won :D';
        this.player.game_over = true;
      }
      return this.player.name + ' score: ' + score_with_ace(score);
    },
  }
});

function suits(){
  return ['❤️','♠️','♦️','♣️'];
};

function cards_by_type(){
  var deck = [
    {name: 'a', value: 11, value_alt: 1},
    {name: 'k', value: 10},
    {name: 'q', value: 10},
    {name: 'j', value: 10}
  ];
  for (var i = 10; i > 1; i--){
    deck.push({name: i, value: i});
  }

  return deck;
};

function get_suits(cards){
  var deck = [];
  cards.forEach(function(card){
    suits().forEach(function(suit){
      var card_copy = JSON.parse(JSON.stringify(card));
      card_copy.suit = suit;
      deck = [...deck, card_copy];
    });
  });
  return deck;
}

function get_cards(){
  return get_suits(cards_by_type());
}

function get_player(){
  return {
    name: 'Player 1',
    score: [0,0],
    has_ace: false,
    hands: [],
    game_status: 'Start the game!',
    game_started: false,
    game_ended: true,
    game_over: false,
  };
}

function get_players(){
  return [
    get_player()
  ];
}

function score_with_ace(score){
  var player_score = score[0];
  var player_score_alt = score[1];
  if (player_score !== player_score_alt){
    return player_score + " (or " + player_score_alt + ")";
  } else {
    return player_score;
  }
}

function default_data(){
  return {
    message: 'Hi Pat!',
    cards: get_cards(),
    players: get_players(),
    current_player: '',
    current_player_index: 0,
    hands: [], // one player
    score: [0,0],
    game_status: 'Start the game!',
    game_started: false,
    game_over: false,
    has_ace: false, // should only have one ace at 11 per round
    dealer_has_ace: false, // should only have one ace at 11 per round
    dealer_score: [0,0],
    dealer_hands: [],
    deal_to_player: true
  };
}

var app = new Vue({
  el: '#app',
  data: default_data(),
  methods: {
    shuffle: function(){
      return this.cards.sort((a, b) => Math.random() > .5 ? -1 : 1);
    },
    deal: function(){
      if (this.game_over) return;
      if (this.game_started){
        this.deal_card(this.pull_card_from_deck());
      } else {
        this.start_game();
      }
    },
    get_card_count_to_deal: function(){
      // start count at 2 for dealer
      return 2 + (this.players.length * 2);
    },
    start_game: function(){
      var appThis = this;
      var cards_to_deal = this.get_card_count_to_deal();
      this.current_player = this.get_first_player();
      for (var i = 0; i < cards_to_deal; i++){
        appThis.deal_card(this.pull_card_from_deck());
        appThis.next_player();
      }
      this.game_started = true;
      this.game_status = 'Playing the game';
    },
    next_player: function(){
      var current_player = this.current_player;
      var next_player = this.get_next_player();
      if (next_player){
        this.current_player = next_player;
        this.deal_to_player = true;
      } else {
        this.current_player = null;
        this.deal_to_player = this.game_started || false;
      }
    },
    deal_card: function(card){
      var current_player = this.current_player;
      if (current_player){
        current_player.hands = [...current_player.hands, card];
        this.update_score(current_player, card);
      } else {
        this.dealer_hands = [...this.dealer_hands, card];
        this.update_dealer_score(card);
      }
    },
    pull_card_from_deck: function(){
      return this.cards.shift();
    },
    player_score: function(score){
      var player_score = score[0];
      if (player_score > 21){
        this.game_status = 'You Lost :(';
        this.game_over = true;
      } else if (player_score === 21){
        this.game_status = 'You Won :D';
        this.game_over = true;
      }
      return score_with_ace(score);
    },
    get_first_player: function(){
      return this.players[0];
    },
    get_next_player: function(){
      return this.current_player ? this.players[this.current_player_index + 1] : this.get_first_player();
    },
    update_score: function(current_player, card){
      // this is doing the heavy work calculating the score
      var card_value = card.value;
      var card_value_alt = card.value_alt;
      var card_is_ace = card_value == 11;

      // don't have two aces at 11 since that would be over 21
      // if this card is an ace and the round already has an ace then add to score by alt value: 1
      // otherwise add by the score
      current_player.score[0] += card_is_ace && current_player.has_ace ? card_value_alt : card_value;
      current_player.score[1] += card_value_alt || card_value;

      // set the state that the ace has been accounted for
      if (card_is_ace && !current_player.has_ace) current_player.has_ace = true;

      // if ace puts score higher than 21 then set score to lower, alt score
      if (current_player.score[0] > 21) current_player.score[0] = current_player.score[1];
    },
    show_dealer_score: function(score){
      return score;
    },
    update_dealer_score: function(card){
      // this is doing the heavy work calculating the score
      var card_value = card.value;
      var card_value_alt = card.value_alt;
      var card_is_ace = card_value == 11;

      // don't have two aces at 11 since that would be over 21
      // if this card is an ace and the round already has an ace then add to score by alt value: 1
      // otherwise add by the score
      this.dealer_score[0] += card_is_ace && this.dealer_has_ace ? card_value_alt : card_value;
      this.dealer_score[1] += card_value_alt || card_value;

      // set the state that the ace has been accounted for
      if (card_is_ace && !this.dealer_has_ace) this.dealer_has_ace = true;

      // if ace puts score higher than 21 then set score to lower, alt score
      if (this.dealer_score[0] > 21) this.dealer_score[0] = this.dealer_score[1];
    },
    restart: function(){
      // https://stackoverflow.com/questions/35604987/is-there-a-proper-way-of-resetting-a-components-initial-data-in-vuejs/35605629
      Object.assign(this.$data, default_data());
    }
  }
});
</script>
